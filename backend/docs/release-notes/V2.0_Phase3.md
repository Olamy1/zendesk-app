# Zendesk App – v2.0 Phase 3 Release Notes

Date: October 2025
Tag: v2.0-phase3

## Summary
Phase 3 delivers backend capabilities to enhance the in-app reporting workflow while ZAT/ZAF preview is pending. We added endpoints for fetching the last N comments for a ticket and exposing metadata about the most recent export. Tests and coverage thresholds were introduced to ensure quality.

## Changes
- Comments API
  - New: `GET /api/v2/tickets/{ticket_id}/comments?limit=3` returns the most recent comments for inline display.
- Export metadata
  - Persists metadata after successful export (timestamp, filename, SharePoint URL, row count, filters).
  - New: `GET /api/v2/tickets/export/last` returns last export metadata for UI surfaces.
- Tests & Coverage
  - Unit + integration tests added (prefix: `test_v2_3_*`).
  - Coverage gate: pytest-cov with 90% minimum for backend.

## Endpoints (v2 preferred)
- Health
  - `GET /health` (public), `GET /api/v2/health`
- Tickets
  - `GET /api/v2/tickets`
  - `PATCH /api/v2/tickets/{ticket_id}`
  - `POST /api/v2/tickets/{ticket_id}/comments`
  - `GET /api/v2/tickets/{ticket_id}/comments?limit=3` (new)
  - `POST /api/v2/tickets/export`
  - `GET /api/v2/tickets/export/last` (new)
- Users
  - `GET /api/v2/users`

## Security & Auth
- All `/api/*` routes require Bearer tokens in production-like environments.
- Bypass remains for `/`, `/docs`, `/openapi.json`, `/redoc`, and unit/test environments.

## Verification
1. Start backend: `uvicorn backend.main:app --reload --port 8080`.
2. Hit `/api/v2/tickets/export/last` → expect `{ ok: false }` before first export.
3. Run an export (`POST /api/v2/tickets/export`), then check `/api/v2/tickets/export/last` → expect `{ ok: true, meta: ... }`.
4. Hit `/api/v2/tickets/{id}/comments?limit=3` → expect most recent comments.
5. Test execution (Phase 3):
   - Unit: `pytest` (backend gate: 90% via pytest-cov)
   - Integration: `pytest -m integration -q -o addopts=''`
   - Both suites pass as of this release.

## Test Matrix (Passing)
- Unit (selected Phase 3 cases)
  - `tests/unit/test_tickets.py::test_export_and_email_success`
  - `tests/unit/test_tickets.py::test_export_and_email_sharepoint_fail`
  - `tests/unit/test_tickets.py::test_export_and_email_email_fail`
  - `tests/unit/test_v2_3_export_success.py::test_v2_3_export_success`
  - `tests/unit/test_v2_3_ticket_comments.py` (comments list)
- Integration
  - `tests/integration/test_security_middleware_integration.py` (401/403/200)
  - `tests/integration/test_tickets_integration.py` (tickets list/patch/comment)
  - `tests/integration/test_users_integration.py` (users list)
  - `tests/integration/test_v2_3_comments_integration.py` (comments)
  - `tests/integration/test_v2_3_export_last_integration.py` (export meta)

## Notes
- UI work to surface “last 3 comments” and “last export” remains pending and will be completed once ZAT preview is available.

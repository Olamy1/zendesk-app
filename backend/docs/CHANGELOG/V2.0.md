# 🧰 Zendesk App — v2.0 App Infrastructure & MVP

**Date:** October 2025
**Tag:** v2.0

---

## 🛠️ Scope

* Environment setup hardening, centralized configuration, and initial API schema validation.
* Baseline backend + frontend wiring for a pilot-ready Zendesk sidebar app.

---

## 🚀 Summary

This iteration establishes a clean, maintainable foundation for **v2.0**.
We centralized environment management, added a documented example `.env`, introduced **Pydantic schemas** for consistent API validation, and wired a startup check to surface runtime configuration at boot.
The app remains aligned with the v1.0 feature set while preparing for additional hardening (versioned routes, unified errors, rate limiting) in the next pass.

---

## 🔐 Configuration & Settings

### 1. `backend/config.py` — Centralized Settings (SSOT-Ready)

* Added `Settings` (Pydantic) with `@lru_cache` accessor via `get_settings()`.
* Loads from `.env` with UTF-8 encoding.
* Startup hook logs environment mode and debug flag.
* **Outcome:** Cleaner configuration surface, ready to be adopted by all services.

### 2. `.env.example` — Onboarding and Safety

* New: `Zendesk_App_clean/.env.example` with placeholders for **Zendesk**, **SharePoint (Graph)**, and **Email/SMTP**.
* Includes `APP_ENV`, `DEBUG`, and `CORS_ORIGINS` for local/dev.
* **Outcome:** Clear, safe, leak-free onboarding.

---

## ⚙️ Backend Core Hardening

### 1. API Schemas — Consistent Validation and Docs

* Added:

  * `backend/schemas/ticket.py` → `Ticket`
  * `backend/schemas/user.py` → `User`
  * `backend/schemas/comment.py` → `Comment`
* Updated:

  * `tickets.py` to validate comment payloads via `Comment` schema.
  * `users.py` to return `response_model=Dict[str, List[User]]`.
* **Outcome:** Predictable request/response shapes and improved Swagger clarity.

### 2. App Startup Diagnostics

* `backend/main.py` logs environment mode at startup using `get_settings()`.
* Fails safely if `.env` is incomplete (prints warning instead of crashing).

---

## 📡 Backend Endpoints

| Endpoint                          | Description                                                     |
| --------------------------------- | --------------------------------------------------------------- |
| `/api/tickets`, `/api/v2/tickets` | Fetch + enrich tickets (meeting window, age, closed-by-meeting) |
| `PATCH /api/tickets/{id}`         | Update status/assignee with auto group sync                     |
| `POST /api/tickets/{id}/comments` | Validate via `Comment` schema                                   |
| `POST /api/export`                | Workbook build + SharePoint upload + email notification         |
| `/api/users`                      | Fetch OAPS users for dropdowns (validated response model)       |

---

## 🖥️ Frontend (ZAF + React)

* Manifest v2.0 with `ticket_sidebar`, `nav_bar`, and `top_bar` locations.
* Ticket table renders core columns and supports inline status/assignee changes.
* Notes editor posts comments; export button triggers SharePoint upload + email.
* Basic styling and bucket/exact age toggle in dashboard view.

---

## 🧪 Tests & Structure

* Unit tests in `tests/unit` covering API surface.
* Structured logger used across services; rate limit handling for Zendesk API.
* **Conftest Refactor & Plugins:**

  * `tests/conftest.py`: Centralized test environment routing (UNIT vs INTEGRATION), Rich diagnostics, and safe FastAPI `TestClient`.
  * `tests/unit/conftest.py`: Enforces UNIT_MODE, imports reporting plugin, and provides fixtures.
  * `tests/plugins/reporting.py`: Adds Rich summaries, latency metrics, and JSON artifacts.

---

## 🧩 Pydantic v2 Integration

* Adopted **Pydantic v2 BaseSettings** for centralized configuration.
* `backend/main.py` uses `get_settings()` to log environment mode and debug flag, failing safely when `.env` is incomplete.

---

## ✅ Checklist Alignment (from TODO_v2_0)

### 🔐 Environment Setup

* [✅] Create dedicated `v2.0_app_infra` branch
* [✅] Remove legacy secrets and rebuild clean repo
* [✅] Validate `.env` structure and `.gitignore` rules
* [✅] Add `config.py` with dotenv integration
* [✅] Create `.env.example` for onboarding

### ⚙️ Backend Core Hardening

* [✅] API schemas for Ticket, User, Comment
* [✅] Unified error handling
* [✅] Versioned routes (`/api/v2/...`)

---

## 📌 Upcoming (v2.0 Next Tasks)

* `/health` endpoint and standardized global error handlers.
* Adopt `get_settings()` across all services (Zendesk, SharePoint, Email).
* Lightweight request auth and versioned routes.
* Frontend: call logging + “last 3 comments” inline display.
* Add “last export” metadata surface in UI.

---

## 🧱 Unified Error Handling — Structured JSON Responses

* Added `backend/utils/error_handler.py` and registered in `backend/main.py`.
* All uncaught exceptions now return structured JSON with status `500`.
* **Outcome:** Cleaner, predictable error responses for frontend and tests.

---

## 🚀 Middleware Enhancements

### 🔒 Security Middleware (`backend/middleware/security.py`)

**Version:** 2.0
**Purpose:** Enforce consistent Bearer token authentication for all protected routes.

#### ✅ Key Updates

* Dynamic Environment Awareness: Uses `get_settings()` for runtime reflection.
* Error Handling Hardening: Converts direct exceptions into structured JSON.
* Bypass Conditions: `/`, `/docs`, `/openapi.json`, `/redoc`, or `UNIT_MODE=1`.
* Logging Integration: Full context for all failures.
* Token Validation: Differentiates missing vs. invalid token (`401` vs `403`).

#### 🧠 Behavior Summary

| Case                 | Status | Description                           |
| -------------------- | ------ | ------------------------------------- |
| Missing Bearer token | 401    | Client omitted `Authorization` header |
| Invalid token        | 403    | Token provided but invalid            |
| Valid token          | 200    | Request proceeds                      |
| Internal error       | 500    | Structured JSON error                 |

---

### 🚦 Rate Limit Middleware (`backend/middleware/rate_limit.py`)

**Version:** 2.0
**Purpose:** Lightweight in-memory per-IP rate limiter.

#### ✅ Key Updates

* Configurable: `RATE_LIMIT_WINDOW` (60s), `MAX_REQUESTS_PER_IP` (30).
* Bypass: When `UNIT_MODE=1` or `APP_ENV ∈ {local, test}`.
* Proxy Awareness: Uses `X-Forwarded-For` headers.
* Thread-Safe Cache: Prunes expired timestamps per request.
* Error Semantics: Returns `429 Too Many Requests` on exceed.

#### 🧠 Behavior Summary

| Case          | Status | Description          |
| ------------- | ------ | -------------------- |
| Within limit  | 200    | Request allowed      |
| Exceeds limit | 429    | Rate limit exceeded  |
| UNIT/test env | 200    | Enforcement disabled |

---

## 🎟️ Tickets API Refactor (`backend/routers/tickets.py`)

**Version:** 2.1.0
**Purpose:** Strengthen reliability, validation, and schema compliance.

#### ✅ Key Updates

* Schema Integration: Enforces structured validation for all requests.
* Error Handling:

  * `400` → Invalid input
  * `502` → Upstream service error
  * `500` → Unexpected error
* Functional Refinements:

  * Auto-fetch `group_id` for reassignment.
  * Unified return: `{ "ok": True, "ticket": {...} }`.
* Export Workflow Stability:

  * Robust SharePoint + email handling.
  * Granular logging per workflow phase.

#### 🧠 Behavior Summary

| Endpoint                        | Success | Client Error | Upstream Error |
| ------------------------------- | ------- | ------------ | -------------- |
| GET /api/tickets                | 200     | —            | —              |
| PATCH /api/tickets/{id}         | 200     | 422          | 502            |
| POST /api/tickets/{id}/comments | 200     | 400          | 502            |
| POST /api/tickets/export        | 200     | —            | 502            |

---

## 🧾 Testing & Validation

* All **unit tests** (`pytest -v tests/unit`) passed under Python 3.13.
* Covered:

  * Security Middleware
  * Rate Limiter
  * Ticket CRUD
  * Comment Validation
* Validation parity between production schemas and test fixtures achieved.

---

## 🧱 Summary of Architectural Impact

| Category    | Change                                          | Outcome                        |
| ----------- | ----------------------------------------------- | ------------------------------ |
| Middleware  | Dynamic env reflection + structured JSON errors | Predictable, testable behavior |
| Tickets API | Schema validation + upstream error handling     | Clean API contracts            |
| Logging     | Context-aware structured logs                   | Faster debugging               |
| Testing     | Aligned mocks + status parity                   | Deterministic outcomes         |

---

# 🧩 Unit Test Enhancements (v2.3.0 | October 2025)

### ✅ Summary

All **unit tests (42 total)** passed successfully following targeted refactors across `backend/routers/tickets.py`, `backend/routers/users.py`, and supporting modules.
This release stabilizes middleware logic, error propagation, and environment handling for `UNIT_MODE` testing.

---

### 🧱 Key Enhancements

#### 1. Security Middleware

* Full FastAPI response alignment.
* ✅ `401` for missing `Authorization`.
* ✅ `403` for invalid token.
* Bypass active for `/docs` and root in `UNIT_MODE`.

#### 2. Tickets Router

* Consolidated duplicate `post_comment()` logic.
* Introduced dynamic environment check:

  ```python
  def is_unit_mode() -> bool:
      return os.getenv("UNIT_MODE", "0") == "1"
  ```
* Updated logic to:

  * Skip live Zendesk calls when `UNIT_MODE=1` (not pytest).
  * Return `400` for simulated Zendesk errors.
  * Propagate `HTTPException` correctly.
  * Refactored logging across branches.
* ✅ Tests:

  * `test_post_comment_zendesk_failure`
  * `test_post_comment_empty`
  * `test_post_comment_success`
    → All passed with expected codes.

#### 3. Users Router

* Added `logger` via `get_logger("users")`.
* Normalized mock output: `{ "users": [{"id": ..., "name": ...}] }`.
* Fixed `NameError: logger not defined`.

#### 4. Test Infrastructure

* Dynamic enforcement for `UNIT_MODE` + `APP_ENV=test`.
* Removed static import caching.
* Consistent startup across all test layers.

---

### 🧪 Validation Results

| Test Suite                      | Status   | Notes                               |
| ------------------------------- | -------- | ----------------------------------- |
| `test_helpers.py`               | ✅ Passed | Helper functions validated          |
| `test_main_startup.py`          | ✅ Passed | App initialization + env validation |
| `test_security_middleware.py`   | ✅ Passed | Token, bypass, routing verified     |
| `test_rate_limit_middleware.py` | ✅ Passed | Window resets + limits enforced     |
| `test_tickets.py`               | ✅ Passed | CRUD, export, and comment flows     |
| `test_users.py`                 | ✅ Passed | User success/failure variants       |
| `test_zendesk_service.py`       | ✅ Passed | Mocked service behaviors            |

---

### 🧩 Version Metadata

* **Version:** `v2.3.0`
* **Author:** Olivier Lamy
* **Date:** October 2025
* **Scope:** Unit Tests Only
* **Coverage:** 100% passing (42 tests)

---

### 🧠 Next Steps

* Migrate `is_unit_mode()` logic to integration and staging.
* Validate RLS + API tokens in `INTEGRATION_MODE=1`.
* Implement coverage reporting and CI workflow (GitHub Actions).

---

# Phase 2 – Frontend Integration (ZAF + Backend)

Date: October 2025
Tag: v2.0-phase2

Summary
- Connects ZAF frontend to the secured backend with a minimal, production-safe shell.
- Adds health endpoints and lightweight frontend call logging for ZAT sandbox pilots.

Changes
- Manifest parameters
  - Added `API_KEY` parameter alongside `BACKEND_BASE_URL`.
  - File: Zendesk_App_clean/frontend/public/manifest.json
- Minimal ZAF assets for ZAT
  - New: `index.html` + SDK and `index.js` under `public/assets/`.
  - Initializes `ZAFClient`, reads parameters, and performs a backend health ping.
  - Files:
    - Zendesk_App_clean/frontend/public/assets/index.html
    - Zendesk_App_clean/frontend/public/assets/index.js
- Health endpoints
  - `GET /health` (public) and `GET /api/v2/health` (versioned) for probes.
  - File: Zendesk_App_clean/backend/main.py
- Frontend request logging
  - Adds `X-Request-Source` and `X-Client-Version` headers and structured console timing.
  - File: Zendesk_App_clean/frontend/services/backendAPI.js
 - Local preview enhancements (no ZAT required)
   - Added `frontend/public/settings.json` for local param injection.
   - `public/assets/index.js` now falls back to URL query params (`?backend=&apikey=`) and `settings.json` when ZAF is not present.
   - `/.env.example` updated to include ZAT preview origin in `CORS_ORIGINS` (`http://localhost:4567`).
   - Files:
     - Zendesk_App_clean/frontend/public/settings.json
     - Zendesk_App_clean/frontend/public/assets/index.js
     - Zendesk_App_clean/.env.example

Security & Behavior Notes
- `TokenAuthMiddleware` bypasses auth for `/` and non-`/api` paths; `/health` is public to allow probes.
- Versioned health (`/api/v2/health`) aligns with protected API semantics.
- CORS remains driven by `CORS_ORIGINS`; headers include source/version for log correlation.

Configuration
- In Zendesk app settings set parameters:
  - `BACKEND_BASE_URL` – deployed backend URL
  - `API_KEY` – optional bearer token if backend enforces it
- Local dev continues to default to `DEFAULT_BACKEND_BASE_URL` in `frontend/src/config.js`.

Verification
- Load app via ZAT; the assets page should display:
  - Backend URL (from parameter)
  - API Key present indicator
  - Health status `ok` from `/health`
- Observe devtools console for request timing and headers; backend should log source/version when available.
 - Without ZAT: open `frontend/public/assets/index.html` and either:
   - Pass `?backend=http://localhost:8080` in the URL, or
   - Edit `frontend/public/settings.json` with your backend URL; health should show `ok`.

TODO Alignment (Phase 2)
- [x] manifest.json SDK v2.0
- [x] Define app parameters (BACKEND_URL, API_KEY)
- [x] Add ticket_sidebar + nav_bar locations
- [x] index.html + SDK script
- [x] index.js to init ZAFClient
- [x] CORS setup for Zendesk origins
- [x] /health endpoint
- [x] Frontend call logging
